<div class="divDayTitle"><a href="http://scripting.com/2018/01/13.html">Saturday, January 13, 2018</a></div>
<div class="divSingularItem" data-type="outline" data-image="http://scripting.com/images/2018/01/13/mushrooms.png"><a name="a191242"></a><img src="http://scripting.com/images/2018/01/13/mushrooms.png" border="0" style="float: right; padding-left: 25px; padding-bottom: 10px; padding-top: 10px; padding-right: 15px;">When I was a kid, at the height of the cold war, I had dreams of looking out my window and seeing dozens of <a href="https://duckduckgo.com/?q=mushroom+cloud&t=hf&iax=images&ia=images">mushroom clouds</a> off in the distance.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13.html#a191242" title="Direct link to this item.">#</a></span></div>
<div class="divSingularItem" data-type="outline"><a name="a025222"></a>The other night <a href="https://en.wikipedia.org/wiki/Julia_Ioffe">Julia Ioffe</a> said something wise on one of the shows: Almost everyone who immigrates comes from a <a href="https://duckduckgo.com/?q=define+shithole&t=hg&ia=definition">shithole</a>. Immigrating is no fun. It has to be worth it. People from Norway don't want to leave because it's not a shithole.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13.html#a025222" title="Direct link to this item.">#</a></span></div>
<div class="divSingularItem" data-type="outline"><a name="a183230"></a>Theory: If two reporters use RSS systematically to gather news, and they combine lists, each reporter gets more value than they would on their own. If interests are aligned, but not too aligned, there's potential value beyond that.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13.html#a183230" title="Direct link to this item.">#</a></span></div>
<div class="divSingularItem" data-type="outline"><a name="a013650"></a>Maybe the thing to do is to start a group of journalists who love and understand <a href="http://cyber.law.harvard.edu/rss/rss.html">RSS</a> and want to use it in new ways to make their journalism better. <span class="spPermaLink"><a href="http://scripting.com/2018/01/13.html#a013650" title="Direct link to this item.">#</a></span></div>
<div class="divTitledItem">
	<div class="divTitle"><a name="a202357"></a><a href="http://scripting.com/2018/01/13/202357.html"><span class="spTitleLink">Wondering..</a></a><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html" title="Direct link to this item.">#</a></span></div>
	<ul class="ulLevel0">
	<li><a name="a202404"></a>I wonder sometimes what goes thru people's minds when you offer to help and it's something you're expert in, and they ignore you.    <span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html#a202404" title="Direct link to this item.">#</a></span></li>
	<li><a name="a202411"></a>It's been happening with news people constantly since I stared working on news software and formats on the web.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html#a202411" title="Direct link to this item.">#</a></span></li>
	<li><a name="a202417"></a>I can't imagine what ulterior motive they think I have. I don't make any money from the work. I do it because I am sure that unless news thrives on the net we are totally screwed.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html#a202417" title="Direct link to this item.">#</a></span></li>
	<li><a name="a202446"></a>Don't they see that too?<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html#a202446" title="Direct link to this item.">#</a></span></li>
	<li><a name="a202447"></a><a href="http://scripting.com/wavs/curly1.wav"><img src="http://static.scripting.com/larryKing/images/2014/03/13/curly.gif" width="53" height="63" border="0" alt="I'm trying to think but nothing happens!"></a><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/202357.html#a202447" title="Direct link to this item.">#</a></span></li>
	</ul>

	</div>
<div class="divTitledItem">
	<div class="divTitle"><a name="a183433"></a><a href="http://scripting.com/2018/01/13/183433.html"><span class="spTitleLink">River5 file-reading problem</a></a><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html" title="Direct link to this item.">#</a></span></div>
	<ul class="ulLevel0">
	<li><a name="a183439"></a>I've now had a chance to study the <a href="https://github.com/scripting/river5/issues/14#issuecomment-356401672">problem</a> reported with <a href="https://github.com/scripting/river5">River5</a> a few days ago. <span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183439" title="Direct link to this item.">#</a></span></li>
	<li><a name="a183523"></a>The first part of solving it was writing down concisely what the problem was. <a href="https://github.com/csenger">Carsten Senger</a> did a great job, but he isn't responsible for the fix, I am. And I wrote the code and am familiar with how it's organized and how it got to be how it is. <span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183523" title="Direct link to this item.">#</a></span></li>
	<li data-subs="[object Object],[object Object],[object Object]"><a name="a183622"></a><b>The problem statement</b><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183622" title="Direct link to this item.">#</a></span></li>
	<ul class="ulLevel1">
	<li><a name="a183655"></a>There are two kinds of rivers, ones associated with a list, and ones associated with a feed. The problem applies to both kinds of rivers, but is more likely to show up in the feed-based ones. <span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183655" title="Direct link to this item.">#</a></span></li>
	<li><a name="a183730"></a>When a new item comes in, it is added to the rivers of all the lists it's in, and in the river for the feed it came from. The river files are stored in files on disk. We cache them in memory. When we want to add an item to a river, we first check if it's in memory. If is, we add the item and we're done. If it's not in memory, we read it from disk, and then add the item to the river. This is where we run into trouble.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183730" title="Direct link to this item.">#</a></span></li>
	<li><a name="a183801"></a>The trouble is that there might be two or more new items from one feed for one river. The first item gets added okay. But when we try to add the second item, since reading the file takes so long, we will find it's not in the cache, so we start a second read. We add our item, but the first item probably isn't in the copy we loaded. It would be an amazing coincidence if it was. So no matter what, we just lost one of the new items from the river. If there are N new items in the first read, we will lose N-1 of them.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183801" title="Direct link to this item.">#</a></span></li>
	</ul>

	<li data-subs="[object Object],[object Object]"><a name="a183943"></a><b>The solution</b><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183943" title="Direct link to this item.">#</a></span></li>
	<ul class="ulLevel1">
	<li><a name="a183906"></a>The best solution is this -- create a queue for each river when the first read is initiated. Add its callback as the first and at that time only item in the queue. If a new read comes in while we're still reading the first one, add its callback to the queue. Once the file is read, call all the callbacks in the queue, concurrently, and delete the queue for that file.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a183906" title="Direct link to this item.">#</a></span></li>
	<li><a name="a184049"></a>I also considered doing it brute force, simply reading all the rivers at startup before doing any feed reads. But I wanted to write the code. And when I did I was glad, it's really interesting how well JavaScript handles this kind of gymnastics. I laughed out loud a few times while putting it together. Code that makes you laugh is worth writing imho. <span class="spOldSchoolEmoji">ðŸ’¥</span><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a184049" title="Direct link to this item.">#</a></span></li>
	</ul>

	<li data-subs="[object Object]"><a name="a184145"></a><b>Code review</b><span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a184145" title="Direct link to this item.">#</a></span></li>
	<ul class="ulLevel1">
	<li><a name="a184151"></a>I put the queue code <a href="https://gist.github.com/scripting/bc335eed01215673cdc0738f8d147025">into a Gist</a> for review. If you spot any problems, post a comment there. Thanks.<span class="spPermaLink"><a href="http://scripting.com/2018/01/13/183433.html#a184151" title="Direct link to this item.">#</a></span></li>
	</ul>

	</ul>

	</div>
